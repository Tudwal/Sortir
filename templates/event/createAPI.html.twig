{% extends 'base.html.twig' %}

{% block title %}Nouvelle sortie
{% endblock %}

{% block body %}
	<div class="container-fluid px-4 mt-4">
		<div class="col-12 my-3">

			{{form_start(formulaire)}}

			<div class="col-2">
				{{form_errors(formulaire.name)}}
				{{form_errors(formulaire.startDateTime)}}
				{{form_errors(formulaire.endRegisterDate)}}
				{{form_errors(formulaire.duration)}}
				{{form_errors(formulaire.nbParticipantMax)}}
				{{form_errors(formulaire.details)}}
			</div>
			<fieldset>
				<legend>Créer une sortie</legend>

				<div class="d-flex">

					<div class="col-6">

						<div class="form-group row">

							<label for="select" class="col-4 col-form-label">
								{{form_label(formulaire.name)}}
							</label>
							<div class="col-6">
								{{form_widget(formulaire.name)}}
							</div>
						</div>
						<div class="form-group row">

							<label for="select" class="col-4 col-form-label">
								{{form_label(formulaire.startDateTime)}}
							</label>
							<div class="col-6">
								{{form_widget(formulaire.startDateTime)}}
							</div>
						</div>
						<div class="form-group row">
							<label for="select" class="col-4 col-form-label">
								{{form_label(formulaire.endRegisterDate)}}
							</label>
							<div class="col-6">
								{{form_widget(formulaire.endRegisterDate)}}
							</div>
						</div>
						<div class="form-group row">
							<label for="select" class="col-4 col-form-label">
								{{form_label(formulaire.nbParticipantMax)}}
							</label>
							<div class="col-6">
								{{form_widget(formulaire.nbParticipantMax)}}
							</div>
						</div>
						<div class="form-group row">
							<label for="select" class="col-4 col-form-label">
								{{form_label(formulaire.duration)}}
							</label>
							<div class="col-6">
								{{form_widget(formulaire.duration)}}
							</div>
						</div>


						<div class="form-group row">
							<label for="select" class="col-4 col-form-label">
								{{form_label(formulaire.details)}}
							</label>
							<div class="col-6">
								{{form_widget(formulaire.details)}}
							</div>
						</div>

					</div>

					<div class="col-6">
						<div class="form-group row">

							<label for="select" class="col-4 col-form-label">
								{{form_label(formulaire.campus)}}
							</label>
							<div class="col-6">
								{{form_widget(formulaire.campus)}}
							</div>
						</div>
						<div class="form-group row">
							<label for="select" class="col-4 col-form-label">
								Ville
							</label>
							<div class="col-6">
								{{form_widget(formulaire.city)}}
							</div>
						</div>


						<div class="form-group row">

							<label for="select" class="col-4 col-form-label">
								{{form_label(formulaire.location)}}
							</label>
							<div class="col-6" name="location" id="location">
								{{form_widget(formulaire.location)}}
							</div>
						</div>
						<div class="form-group row">
							<label for="select" class="col-4 col-form-label">
								Rue
							</label>
							<div class="col-6" name='streetView' id='streetView'></div>
						</div>
						<div class="form-group row">
							<label for="select" class="col-4 col-form-label">
								Code postal
							</label>
							<div class="col-6" name='codePostal' id='codePostal'></div>
						</div>
						<div class="form-group row">
							<label for="select" class="col-4 col-form-label">
								Latitude
							</label>
							<div class="col-6" name='latitude' id='latitude'></div>
						</div>
						<div class="form-group row">
							<label for="select" class="col-4 col-form-label">
								Longitude
							</label>
							<div class="col-6" name='longitude' id='longitude'></div>
						</div>
					</div>
				</div>
			</fieldset>
			<div class="my-4">
				<button class="btn btn-primary" type="submit">Créer la sortie
					<span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-secondary"></span>
				</button>
				<button class="btn btn-success" type="submit">Publier la sortie
					<span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-secondary"></span>
				</button>
				<a href="{{ path('home')}}" class="btn btn-warning">
					Annuler
					<span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-secondary"></span>
				</a>
			</div>
			{{form_end(formulaire)}}
		</div>
	</div>

	<script>

		let cities = {};
let url = 'http://localhost/Sortir/public/home/api/';
fetch(url).then(res => res.json()).then(data => {
cities = data
console.log(data);
afficherCity();
afficherLocation(cities[0].id);


});

function afficherCity() { // alimenter select city
let baliseCity = document.querySelector('#event_type_api_city');
for (let c of cities) {
option = document.createElement('option'); // <option></option>
option.innerHTML = c.name; // <option>Rennes</option>
option.setAttribute('value', c.id); // <option value="1">Rennes</option>
baliseCity.appendChild(option);


}
}

// alimenter select Location
function afficherLocation(cityId) {
let baliseLocation = document.querySelector('#event_type_api_location');
// vider la balise select du Location
baliseLocation.innerHTML = '';
// rechercher ts les Locations correspondant à la city
for (let c of cities) {
console.log('je suis dans le premier IF')
if (c.id == cityId) {
for (let l of c.locations) {
console.log('je suis dans le deuxième IF')
let option = document.createElement('option'); // <option></option>
option.innerHTML = l.name;
// <option>Mairie</option>
option.setAttribute('value', l.id);
// <option value="1">Mairie</option>
baliseLocation.appendChild(option);

}
}
}
}

function afficherCodePostal(cityId) {
let cp = document.querySelector('#codePostal');
for (let c of cities) {
if (c.id == cityId) {
cp.innerHTML = c.postalCode;
}
}
}

function afficherInfoLocation(locationId, cityId) {
console.log('Je rentre dans la fonction afficherInfoLocation')
let street = document.querySelector('#streetView');
let latitude = document.querySelector('#latitude');
let longitude = document.querySelector('#longitude');
for (let c of cities) {
if (c.id == cityId) {
console.log('Je rentre dans le 1er if de la fonction afficherInfolocation')
for (let l of c.locations) {
if (l.id == locationId) {
street.innerHTML = l.street;
latitude.innerHTML = l.latitude;
longitude.innerHTML = l.longitude;
console.log("je suis dans le 2eme if de la fonction afficherInfolocation");
}
}
}
}
}

// Demander à afficher les bonnes Locations et le code postal à chaque changement de City
document.querySelector('#event_type_api_city').onchange = function () {
let cityId = document.querySelector('#event_type_api_city').value;
let locationId = document.querySelector('#event_type_api_location').value;
afficherLocation(cityId);
afficherCodePostal(cityId);


}

// Demander à afficher la rue, latitude et longitude de la Location choisie
document.querySelector('#event_type_api_location').onchange = function () {
let id = document.querySelector('#event_type_api_location').value;
let cityId = document.querySelector('#event_type_api_city').value;
afficherInfoLocation(id, cityId);
}
	</script>
{% endblock %}
